<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mafia Game Test</title>
</head>
<body>
  <h1>Mafia Game API Test</h1>
  <button onclick="runTest()">Run Full 1-Day Simulation</button>
  <pre id="output"></pre>

<script>
const API_BASE = "http://localhost:5000"; // Adjust if your backend port differs
let token = "";
let gameId = null;
let players = [];
let gamePlayers = [];

async function log(msg) {
  document.getElementById("output").textContent += msg + "\n";
  console.log(msg);
}

// Helper: Fetch wrapper
async function api(endpoint, method = "GET", body = null) {
  const options = {
    method,
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    }
  };
  if (body) options.body = JSON.stringify(body);

  const res = await fetch(`${API_BASE}${endpoint}`, options);
  return res.json();
}

// Step 1: Login
async function login() {
  const res = await fetch(`${API_BASE}/auth/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: "admin", password: "admin123" }) // replace with your credentials
  });
  const data = await res.json();
  token = data.token;
  await log("Logged in. Token acquired.");
}

// Step 2: Create Game
async function createGame() {
  const res = await api("/games", "POST");
  gameId = res.game_id;
  await log(`Game created with ID: ${gameId}`);
}

// Step 3: Add Players
async function addPlayers() {
  // Example random players and roles
  players = [
    { name: "Alice", role_id: 1, side: "citizen" },
    { name: "Bob", role_id: 2, side: "mafia" },
    { name: "Charlie", role_id: 1, side: "citizen" },
    { name: "David", role_id: 2, side: "mafia" },
    { name: "Eve", role_id: 1, side: "citizen" }
  ];

  // First register players in system (if not already exists)
  for (let p of players) {
    await api("/players", "POST", { name: p.name });
  }

  // Now assign them to the game
  const gamePlayersData = players.map((p, index) => ({
    player_id: index + 1,  // assuming sequential IDs from DB
    role_id: p.role_id,
    seat: index + 1,
    side: p.side
  }));

  await api(`/games/${gameId}/players`, "POST", gamePlayersData);
  await log(`Added ${players.length} players to game.`);
}

// Step 4: Assign Initial Seat
async function assignInitialSeats() {
  const startingPlayerId = 1; // Choose first player's gamePlayerId (simulate Alice as #1)
  await api(`/games/${gameId}/seats`, "POST", { startingPlayerId });
  await log("Seats assigned starting with Alice.");
}

// Step 5: Log Actions (Day Phase)
async function logDayActions() {
  // Example: Player 1 targets player 2
  await api(`/actions/log`, "POST", {
    gamePlayerId: 1,
    actionTypeId: 1, // "target"
    targets: [2],
    notes: "Targeted Bob"
  });
  await log("Player 1 performed 'target' action.");
}

// Step 6: Advance Phase → Voting → Night → Day
async function cyclePhases() {
  await api(`/games/${gameId}/advance-phase`, "PATCH");
  await log("Advanced to voting phase.");

  await api(`/games/${gameId}/advance-phase`, "PATCH");
  await log("Advanced to night phase.");

  await api(`/games/${gameId}/advance-phase`, "PATCH");
  await log("Advanced to next day.");
}

// Full Simulation
async function runTest() {
  document.getElementById("output").textContent = ""; // clear log

  await login();
  await createGame();
  await addPlayers();
  await assignInitialSeats();
  await logDayActions();
  await cyclePhases();

  await log("Simulation completed for 1 day cycle.");
}
</script>
</body>
</html>
